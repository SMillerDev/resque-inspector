{{define "footer"}}
    <span class="float-end">Connected to <code>{{$.Dsn}}</code></span>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script>
        function loadData(page) {
            switch (page) {
                case 'queues':
                    loadQueues();
                    break;
                case 'workers':
                    loadWorkers()
                    break;
                case '':
                    loadJobs()
                    break;
                default:
                    console.warn(`No data to load for ${page}`)
                    break;
            }
        }
        function generateFilter() {
            let queue = document.getElementById("queues").value;
            let regex = document.getElementById("regex").value;
            let className = document.getElementById("classes").value;
            let exception = "";
            if (!document.getElementById("exceptions-wrapper").classList.contains("d-none")) {
                exception = document.getElementById("exceptions").value;
            }

            return {
                regex: regex,
                class: className,
                exception: exception,
                queue: queue,
                startDate: 0,
                endDate: Date.now(),
            }
        }

        function loadJobs() {
            const filter = generateFilter();
            getApi(`queues/${filter.queue}/jobs`, filter).then(function (json) {
                if (json === null) {
                    console.log("No job data!")
                    return
                }
                if (filter.queue !== 'failed') {
                    document.getElementById("exceptions-wrapper").classList.add("d-none");
                }

                let classes = json["classes"].filter(onlyUnique);
                let classHtml = `<option ${filter.class ? '' : 'selected'} value="">-- Select class --</option>`;
                classes.forEach(className => {
                    classHtml += `<option value='${className}' ${(filter.class == className) ? 'selected' : ''}>${className}</option>`;
                });
                document.getElementById("classes").innerHTML = classHtml;


                let html = "";
                json["items"].forEach(item => {
                    html += `<tr><td>${item["class"]}</td><td>${(new Date(item["queue_time"] * 1000)).toISOString()}</td></tr>`
                });
                document.getElementById("jobList").innerHTML = `<thead><tr><th scope="col">Class</th><th scope="col">Queued At</th></tr></thead><tbody>${html}</tbody>`;
            }).catch(function (reason) {
                console.log(reason)
            });
        }

        function loadQueues() {
            const filter = {};
            getApi("queues", filter).then(function (json) {
                if (json === null) {
                    console.log("No Queue data!")
                    return
                }
                let html = "";
                json["items"].forEach(item => {
                    html += `<tr><td>${item["name"]}</td><td>${item["job_count"]}</td><td><a href="/?queue=${item["id"]}" class="btn btn-primary">Jobs</a> <a href="#" class="btn btn-danger">Clear</a></td></tr>`
                });
                let table = document.getElementById("queueList");
                table.innerHTML = `<thead><tr><th scope="col">Queue</th><th scope="col">Items</th><th scope="col"></th></tr></thead><tbody>${html}</tbody>`;
            }).catch(function (reason) {
                console.log(reason)
            });
        }

        function loadWorkers() {
            const filter = {};
            getApi("workers", filter).then(function (json) {
                if (json === null) {
                    console.log("No worker data!")
                    return
                }
                let html = "";
                for (const key in json["items"]) {
                    const list = json["items"][key];
                    list.forEach(item => {
                        if (item["entry"]["class"] == "") {
                            html += `<tr><td>${key}</td><td>${item["host"]}</td><td>${item["socket"]}</td><td></td></tr>`;
                            return;
                        }

                        html += `<tr><td>${key}</td><td>${item["host"]}</td><td>${item["socket"]}</td><td>$JSON.stringify({item["entry"])}</td></tr>`
                    });

                }
                let table = document.getElementById("workerList");
                table.innerHTML = `<thead><tr><th scope="col">Worker</th><th scope="col">Items</th></tr></thead><tbody>${html}</tbody>`;
            }).catch(function (reason) {
                console.log(reason)
            });
        }

        function query(obj) {
            let str = [];
            for (const p in obj) {
                if (obj.hasOwnProperty(p) && obj[p] != undefined) {
                    str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
                }
            }

            return str.join("&");
        }

        async function getApi(path, filter, start = 0, offset = 25) {
            const url = `/api/v1/${path}?${query(filter)}&start=${start}&offset=${offset}`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Response status: ${response.status}`);
            }

            return await response.json()
        }

        function onlyUnique(value, index, array) {
            return array.indexOf(value) === index;
        }
    </script>
    </body>
    </html>
{{end}}